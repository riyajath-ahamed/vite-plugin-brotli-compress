name: Automated Versioning

on:
  push:
    branches:
      - main

jobs:
  version-check:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Check for version bump
        id: version-check
        run: |
          # Get the last commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          
          # Check if commit message indicates version bump
          if [[ "$COMMIT_MSG" =~ ^(feat|feature)(\(.+\))?: ]]; then
            echo "bump=minor" >> $GITHUB_OUTPUT
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "Detected minor version bump"
          elif [[ "$COMMIT_MSG" =~ ^(fix|bugfix)(\(.+\))?: ]]; then
            echo "bump=patch" >> $GITHUB_OUTPUT
            echo "type=patch" >> $GITHUB_OUTPUT
            echo "Detected patch version bump"
          elif [[ "$COMMIT_MSG" =~ ^(BREAKING CHANGE|breaking change) ]]; then
            echo "bump=major" >> $GITHUB_OUTPUT
            echo "type=major" >> $GITHUB_OUTPUT
            echo "Detected major version bump"
          elif [[ "$COMMIT_MSG" =~ ^(chore|docs|style|refactor|perf|test)(\(.+\))?: ]]; then
            echo "bump=patch" >> $GITHUB_OUTPUT
            echo "type=patch" >> $GITHUB_OUTPUT
            echo "Detected patch version bump for maintenance"
          else
            echo "bump=none" >> $GITHUB_OUTPUT
            echo "type=none" >> $GITHUB_OUTPUT
            echo "No version bump needed"
          fi

      - name: Bump version
        if: steps.version-check.outputs.bump != 'none'
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Bump version
          npm version ${{ steps.version-check.outputs.type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"
          
          # Commit version bump
          git add package.json
          git commit -m "chore: bump version to $NEW_VERSION"
          
          # Create and push tag
          git tag "v$NEW_VERSION"
          git push origin main
          git push origin "v$NEW_VERSION"

      - name: Create Release PR
        if: steps.version-check.outputs.bump != 'none'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: prepare release v${{ steps.version-check.outputs.new-version }}"
          title: "Release v${{ steps.version-check.outputs.new-version }}"
          body: |
            ## Release v${{ steps.version-check.outputs.new-version }}
            
            This PR prepares the release for version ${{ steps.version-check.outputs.new-version }}.
            
            ### Changes in this release:
            - ${{ github.event.head_commit.message }}
            
            ### Release Notes:
            Please review and update the release notes before merging.
            
            - [ ] Update CHANGELOG.md
            - [ ] Review release notes
            - [ ] Merge to trigger release workflow
          branch: release/v${{ steps.version-check.outputs.new-version }}
          delete-branch: true
